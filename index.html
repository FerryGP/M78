<!--
 * é¡¹ç›®åç§°ï¼šM78æ˜Ÿäº‘ä¸çŒæˆ·åº§ 3D å¯è§†åŒ–æ¼”ç¤º
 * è¯´æ˜ï¼šè¯¥æ¨¡å‹ä»…ç”¨äºå‚åŠ ç¬¬äºŒåå…­å±Šé‡‘é¹ç§‘æŠ€è®ºå›
 * ä½œè€…ï¼šä¸‰å¹´çº§7ç­ ç‹åŸé©°
 * ç‰ˆæƒæ‰€æœ‰ï¼šç‹åŸé©°
-->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>M78æ˜Ÿäº‘ä¸çŒæˆ·åº§ 3D å¯è§†åŒ–æ¼”ç¤º - ç‹åŸé©°</title>
    <!-- å¼•å…¥ Tailwind CSS è¿›è¡Œ UI æ ·å¼è®¾è®¡ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- å¼•å…¥ OrbitControls ç”¨äºé¼ æ ‡æ§åˆ¶ -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <!-- å¼•å…¥ Tween.js ç”¨äºå¹³æ»‘åŠ¨ç”» -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #canvas-container { width: 100vw; height: 100vh; display: block; }
        
        /* æ ‡ç­¾æ ·å¼ */
        .star-label {
            position: absolute;
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            pointer-events: none;
            user-select: none;
            text-shadow: 0 0 4px #000;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
            transform: translate(-50%, -150%);
            z-index: 5;
        }

        .star-label.visible { opacity: 1; }

        .label-name { font-weight: bold; font-size: 14px; }
        .label-dist { font-size: 11px; color: #aaa; }

        /* M78 ç‰¹æ•ˆæ ·å¼ */
        .m78-highlight {
            color: #ff88ff;
            text-shadow: 0 0 10px #ff00ff;
        }

        /* æ§ä»¶é¢æ¿ */
        #controls-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(20, 20, 30, 0.9);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            color: white;
            z-index: 10;
            width: 300px;
            max-width: calc(100vw - 40px); /* ç§»åŠ¨ç«¯é˜²æº¢å‡º */
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* æŠ˜å çŠ¶æ€æ ·å¼ */
        #controls-panel.collapsed {
            width: auto;
            min-width: 140px;
            background: rgba(20, 20, 30, 0.6);
        }

        /* é¢æ¿å¤´éƒ¨ï¼ˆå§‹ç»ˆå¯è§ï¼‰ */
        .panel-header {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .toggle-icon {
            transition: transform 0.3s;
        }
        
        #controls-panel.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }
        
        #controls-panel.collapsed .panel-header {
            border-bottom: none;
        }

        /* é¢æ¿å†…å®¹åŒºåŸŸ */
        .panel-content-wrapper {
            padding: 20px;
            padding-top: 15px;
            transition: opacity 0.3s ease;
            opacity: 1;
        }

        #controls-panel.collapsed .panel-content-wrapper {
            display: none;
            opacity: 0;
        }

        .btn {
            display: block;
            width: 100%;
            padding: 10px 15px;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #1e3a8a, #3b82f6);
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
            text-align: left;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.5);
        }

        .btn-icon { font-size: 1.2em; margin-right: 10px; }

        /* ç®€å•æ‚¬æµ®æç¤º */
        #tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #444;
            color: #fff;
            padding: 6px 10px;
            border-radius: 4px;
            pointer-events: none;
            display: none;
            z-index: 20;
            font-size: 12px;
        }

        /* è¯¦æƒ…æ¨¡æ€æ¡† */
        #detail-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 400px;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 16px;
            padding: 24px;
            color: white;
            z-index: 100;
            display: none;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8), 0 0 15px rgba(59, 130, 246, 0.2);
            backdrop-filter: blur(12px);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        #detail-modal.active {
            display: block;
            opacity: 1;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: #aaa;
            font-size: 20px;
            cursor: pointer;
            transition: color 0.2s;
        }
        .close-btn:hover { color: white; }

        .modal-title { font-size: 24px; font-weight: bold; margin-bottom: 5px; color: #60a5fa; }
        .modal-subtitle { font-size: 14px; color: #94a3b8; margin-bottom: 15px; border-bottom: 1px solid #334155; padding-bottom: 10px;}
        .modal-body { font-size: 15px; line-height: 1.6; color: #e2e8f0; }

        .loading-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 999;
            transition: opacity 1s ease-out;
        }
    </style>
</head>
<body>

    <!-- åŠ è½½å±‚ -->
    <div id="loading" class="loading-overlay">
        <div class="text-center">
            <h1 class="text-2xl font-bold mb-2">M78æ˜Ÿäº‘ä¸çŒæˆ·åº§ 3D æ¼”ç¤º</h1>
            <p class="text-gray-400">æ­£åœ¨æ„å»ºå®‡å®™åœºæ™¯...</p>
        </div>
    </div>

    <!-- 3D å®¹å™¨ -->
    <div id="canvas-container"></div>

    <!-- æ‚¬æµ®æç¤ºæ¡† -->
    <div id="tooltip"></div>

    <!-- è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="detail-modal">
        <button class="close-btn" onclick="closeModal()">Ã—</button>
        <div id="modal-content">
            <!-- å†…å®¹å°†é€šè¿‡ JS åŠ¨æ€å¡«å…… -->
        </div>
    </div>

    <!-- UI æ§åˆ¶é¢æ¿ (å¸¦æŠ˜å åŠŸèƒ½) -->
    <div id="controls-panel">
        <!-- æ ‡é¢˜æ  (ç‚¹å‡»å¯æŠ˜å ) -->
        <div class="panel-header" onclick="togglePanel()">
            <div class="font-bold text-blue-200 flex items-center">
                <span class="mr-2">âš™ï¸</span> æ§åˆ¶é¢æ¿
            </div>
            <div class="toggle-icon text-gray-400 text-sm">â–¼</div>
        </div>

        <!-- å¯æŠ˜å å†…å®¹åŒº -->
        <div class="panel-content-wrapper">
            <!-- æ–°å¢çš„æ ‡é¢˜ -->
            <h3 class="text-lg font-bold text-blue-100 mb-3 leading-tight border-b border-gray-700 pb-2">
                M78æ˜Ÿäº‘ä¸çŒæˆ·åº§<br>
                <span class="text-sm text-blue-300 font-normal">3D å¯è§†åŒ–äº¤äº’æ¼”ç¤º</span>
            </h3>

            <p class="text-xs text-gray-400 mb-4">æ¢ç´¢â€œé‹ç›’æ¨¡å‹â€åŸç†ï¼šä»åœ°çƒçœ‹ä¼¼å¹³é¢ï¼Œå®åˆ™æ·±åº¦å·®å¼‚å·¨å¤§ã€‚</p>
            
            <button class="btn" onclick="setEarthView()">
                <span><span class="btn-icon">ğŸŒ</span>åœ°çƒè§†è§’</span>
                <span class="text-xs opacity-70">å¹³é¢æ˜Ÿåº§å›¾</span>
            </button>
            
            <button class="btn" onclick="setGodView()">
                <span><span class="btn-icon">ğŸ›¸</span>ä¸Šå¸è§†è§’</span>
                <span class="text-xs opacity-70">ä¾§é¢çœ‹æ·±åº¦</span>
            </button>

            <div class="mt-4 pt-4 border-t border-gray-700">
                <div class="flex items-center text-xs text-gray-300 mb-2">
                    <div class="w-3 h-3 rounded-full bg-green-500 mr-2 shadow-[0_0_5px_#22c55e]"></div>
                    åœ°çƒ (åŸç‚¹)
                </div>
                <div class="flex items-center text-xs text-gray-300 mb-2">
                    <div class="w-3 h-3 rounded-full bg-blue-500 mr-2 shadow-[0_0_5px_#3b82f6]"></div>
                    æ’æ˜Ÿ (å¦‚å‚å®¿å››)
                </div>
                <div class="flex items-center text-xs text-gray-300">
                    <div class="w-3 h-3 rounded-full bg-fuchsia-500 mr-2 shadow-[0_0_5px_#d946ef]"></div>
                    M78 æ˜Ÿäº‘ (æœ€è¿œ)
                </div>
            </div>
            
            <div class="mt-4 text-xs text-gray-500 text-center border-b border-gray-700 pb-4 mb-4">
                å•å‡»æ˜Ÿä½“æŸ¥çœ‹è¯¦æƒ…<br>
                é¼ æ ‡æ‹–æ‹½æ—‹è½¬ | æ»šè½®ç¼©æ”¾
            </div>

            <!-- ç‰ˆæƒè¯´æ˜ -->
            <div class="text-[10px] text-gray-400 text-center leading-relaxed">
                è¯¥æ¨¡å‹ä»…ç”¨äºå‚åŠ <br>
                <span class="text-yellow-500 font-bold">ç¬¬äºŒåå…­å±Šé‡‘é¹ç§‘æŠ€è®ºå›</span><br>
                ä¸‰å¹´çº§7ç­ ç‹åŸé©° ç‰ˆæƒæ‰€æœ‰
            </div>
        </div>
    </div>

    <script>
        // --- 1. æ•°æ®é…ç½® (åŸºäºç”¨æˆ·æä¾›çš„æœ€æ–°å¤©æ–‡æ•°æ®æ ¡å‡†) ---
        // è§†è§‰ç¼©æ”¾å› å­ï¼Œä¿æŒæ˜Ÿå›¾çš„ç›¸å¯¹å½¢çŠ¶
        const XY_SCALE = 30; 
        
        // ç¥èˆŸé£èˆ¹é€Ÿåº¦è®¡ç®—å¸¸æ•°
        const YEARS_PER_LY_SHENZHOU = 38000;

        const starData = [
            // Betelgeuse
            { 
                id: 'betelgeuse', name: "å‚å®¿å›› (Betelgeuse)", color: 0xff4500, size: 6, x: 2, y: 4, z: 640,
                desc: "è¿™æ˜¯ä¸€é¢—çº¢è¶…å·¨æ˜Ÿï¼Œå·²ç»æ¥è¿‘å…¶ç”Ÿå‘½çš„ç»ˆç‚¹ã€‚å¦‚æœæŠŠå®ƒæ”¾åœ¨æˆ‘ä»¬å¤ªé˜³ç³»ä¸­å¿ƒï¼Œå®ƒçš„è¡¨é¢å°†å»¶ä¼¸åˆ°æœ¨æ˜Ÿè½¨é“ä¹‹å¤–ã€‚å®ƒæ˜¯å¤©ç©ºä¸­ç¬¬ä¹äº®çš„æ˜Ÿã€‚"
            },
            // Bellatrix
            { 
                id: 'bellatrix', name: "å‚å®¿äº” (Bellatrix)", color: 0xadd8e6, size: 4, x: -2, y: 4, z: 250,
                desc: "ä¹Ÿè¢«ç§°ä¸ºâ€œäºšé©¬é€Šå¥³æˆ˜å£«ä¹‹æ˜Ÿâ€ã€‚è™½ç„¶åœ¨çŒæˆ·åº§ä¸»è¦æ’æ˜Ÿä¸­çœ‹èµ·æ¥è¾ƒæš—ï¼Œä½†å®ƒæ˜¯è·ç¦»åœ°çƒæœ€è¿‘çš„çŒæˆ·åº§ä¸»æ˜Ÿä¹‹ä¸€ï¼Œä»…çº¦250å…‰å¹´ã€‚"
            },
            // Rigel
            { 
                id: 'rigel', name: "å‚å®¿ä¸ƒ (Rigel)", color: 0xaaaaff, size: 7, x: -2, y: -4, z: 860,
                desc: "çŒæˆ·åº§æœ€äº®çš„æ˜Ÿï¼ˆé€šå¸¸æ¯”å‚å®¿å››äº®ï¼‰ï¼Œä¹Ÿæ˜¯å…¨å¤©ç¬¬ä¸ƒäº®æ˜Ÿã€‚å®ƒæ˜¯ä¸€é¢—è“è¶…å·¨æ˜Ÿï¼Œå…‰åº¦çº¦ä¸ºå¤ªé˜³çš„12ä¸‡å€ã€‚"
            },
            // Saiph
            { 
                id: 'saiph', name: "å‚å®¿å…­ (Saiph)", color: 0xadd8e6, size: 4, x: 2, y: -4, z: 720,
                desc: "ä½äºçŒæˆ·åº§çš„å³è†ï¼ˆä»åœ°çƒçœ‹æ˜¯å·¦ä¸‹è§’ï¼‰ã€‚è™½ç„¶è·ç¦»å’Œå‚å®¿ä¸ƒç›¸ä»¿ï¼Œä½†ç”±äºå¤§éƒ¨åˆ†èƒ½é‡ä»¥ç´«å¤–çº¿å½¢å¼è¾å°„ï¼Œè§†è§‰ä¸Šçœ‹èµ·æ¥ä¸å¦‚å‚å®¿ä¸ƒæ˜äº®ã€‚"
            },
            // Mintaka (ä¿®æ­£ï¼š915å…‰å¹´)
            { 
                id: 'mintaka', name: "å‚å®¿ä¸‰ (Mintaka)", color: 0x00bfff, size: 3.5, x: -0.5, y: 0, z: 915,
                desc: "ä½äºçŒæˆ·åº§è…°å¸¦çš„æœ€å³ä¾§ï¼ˆè¥¿ï¼‰ã€‚å®é™…ä¸Šæ˜¯ä¸€ä¸ªå¤æ‚çš„å¤šæ˜Ÿç³»ç»Ÿã€‚**è·ç¦»åœ°çƒçº¦915å…‰å¹´**ï¼Œæ¯”æœ€å·¦ä¾§çš„å‚å®¿ä¸€è¦è¿œä¸€äº›ã€‚"
            },
            // Alnilam (ä¿®æ­£ï¼š1340å…‰å¹´)
            { 
                id: 'alnilam', name: "å‚å®¿äºŒ (Alnilam)", color: 0x00bfff, size: 3.5, x: 0, y: 0, z: 1340,
                desc: "ä½äºçŒæˆ·åº§è…°å¸¦çš„æ­£ä¸­å¤®ã€‚å®ƒæ˜¯è…°å¸¦ä¸‰æ˜Ÿä¸­è·ç¦»æˆ‘ä»¬æœ€è¿œçš„ï¼ˆ1340å…‰å¹´ï¼‰ï¼Œä½†å› ä¸ºå®ƒæåº¦æ˜äº®ï¼Œçœ‹èµ·æ¥ä¸å…¶ä»–ä¸¤é¢—æ˜Ÿäº®åº¦ç›¸å½“ã€‚"
            },
            // Alnitak (ä¿®æ­£ï¼š800å…‰å¹´)
            { 
                id: 'alnitak', name: "å‚å®¿ä¸€ (Alnitak)", color: 0x00bfff, size: 3.5, x: 0.5, y: 0, z: 800,
                desc: "ä½äºçŒæˆ·åº§è…°å¸¦çš„æœ€å·¦ä¾§ï¼ˆä¸œï¼‰ã€‚**è·ç¦»åœ°çƒçº¦800å…‰å¹´**ã€‚è‘—åçš„é©¬å¤´æ˜Ÿäº‘å°±ä½äºè¿™é¢—æ˜Ÿçš„é™„è¿‘ã€‚"
            },
            // M78
            { 
                id: 'm78', name: "M78 æ˜Ÿäº‘", type: "nebula", color: 0xff00ff, size: 15, x: 0.8, y: 0.5, z: 1600,
                desc: "è¿™æ˜¯ä¸€ä¸ªåå°„æ˜Ÿäº‘ï¼Œæ„å‘³ç€å®ƒé€šè¿‡åå°„é™„è¿‘æ’æ˜Ÿçš„å…‰çº¿å‘å…‰ã€‚åœ¨æ¼”ç¤ºä¸­ï¼Œæˆ‘ä»¬å°†å…¶è·ç¦»å¤¸å¼ åŒ–å±•ç¤ºä»¥çªå‡ºæ·±åº¦ï¼Œå®é™…è·ç¦»çº¦1600å…‰å¹´ã€‚"
            }
        ];

        // ä¿®æ­£æ•°æ®æ ¼å¼å¹¶åº”ç”¨ç¼©æ”¾
        const stars = starData.map(s => ({
            ...s,
            realX: s.x * XY_SCALE, // ç¼©æ”¾åçš„ 3D ç©ºé—´åæ ‡
            realY: s.y * XY_SCALE,
            realZ: s.z
        }));

        // è¿çº¿å®šä¹‰ (ç´¢å¼•å¯¹åº”ä¸Šè¿°æ•°ç»„)
        const connections = [
            [0, 6], // å‚å®¿å›› -> å‚å®¿ä¸€
            [1, 4], // å‚å®¿äº” -> å‚å®¿ä¸‰
            [0, 1], // å‚å®¿å›› -> å‚å®¿äº”
            [3, 6], // å‚å®¿å…­ -> å‚å®¿ä¸€
            [2, 4], // å‚å®¿ä¸ƒ -> å‚å®¿ä¸‰
            [3, 2], // å‚å®¿å…­ -> å‚å®¿ä¸ƒ
            [4, 5], // è…°å¸¦ å³-ä¸­
            [5, 6]  // è…°å¸¦ ä¸­-å·¦
        ];

        // --- 2. Three.js åˆå§‹åŒ– ---
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x000000, 0.0002);

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 5000);
        
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        container.appendChild(renderer.domElement);

        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;

        // --- 3. è¾…åŠ©å‡½æ•°ï¼šç”Ÿæˆçº¹ç† ---
        function createGlowTexture(colorStr) {
            const canvas = document.createElement('canvas');
            canvas.width = 64; canvas.height = 64;
            const ctx = canvas.getContext('2d');
            const gradient = ctx.createRadialGradient(32, 32, 0, 32, 32, 32);
            gradient.addColorStop(0, 'rgba(255, 255, 255, 1)');
            gradient.addColorStop(0.2, colorStr); 
            gradient.addColorStop(0.5, 'rgba(0, 0, 0, 0)');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 64, 64);
            return new THREE.CanvasTexture(canvas);
        }

        function createNebulaTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 128; canvas.height = 128;
            const ctx = canvas.getContext('2d');
            const grad = ctx.createRadialGradient(64, 64, 10, 64, 64, 60);
            grad.addColorStop(0, 'rgba(255, 0, 255, 0.8)');
            grad.addColorStop(0.6, 'rgba(200, 0, 200, 0.2)');
            grad.addColorStop(1, 'rgba(0,0,0,0)');
            ctx.fillStyle = grad;
            ctx.fillRect(0,0,128,128);
            return new THREE.CanvasTexture(canvas);
        }

        // --- 4. åœºæ™¯æ„å»º ---
        const starMeshes = [];
        const labelElements = [];
        let m78Mesh = null;
        let m78Glow = null;

        stars.forEach((star, index) => {
            const geometry = new THREE.SphereGeometry(star.size, 32, 32);
            const material = new THREE.MeshBasicMaterial({ color: star.color });
            
            const mesh = new THREE.Mesh(geometry, material);
            mesh.position.set(star.realX, star.realY, star.realZ);
            mesh.userData = { ...star }; // å­˜å‚¨æ•°æ®
            scene.add(mesh);
            starMeshes.push(mesh);

            const spriteMaterial = new THREE.SpriteMaterial({ 
                map: createGlowTexture(star.type === 'nebula' ? 'rgba(255,0,255,0.6)' : 'rgba(100,150,255,0.6)'),
                color: star.color, 
                transparent: true, 
                blending: THREE.AdditiveBlending,
                opacity: 0.8
            });
            const sprite = new THREE.Sprite(spriteMaterial);
            const scale = star.size * 6; 
            sprite.scale.set(scale, scale, 1);
            mesh.add(sprite);

            if (star.type === 'nebula') {
                m78Mesh = mesh;
                const nebulaGeo = new THREE.BufferGeometry();
                const count = 30;
                const positions = new Float32Array(count * 3);
                for(let i=0; i<count; i++) {
                    positions[i*3] = (Math.random() - 0.5) * 40;
                    positions[i*3+1] = (Math.random() - 0.5) * 40;
                    positions[i*3+2] = (Math.random() - 0.5) * 40;
                }
                nebulaGeo.setAttribute('position', new THREE.BufferAttribute(positions, 3));
                const nebulaMat = new THREE.PointsMaterial({
                    size: 30,
                    map: createNebulaTexture(),
                    transparent: true,
                    depthWrite: false,
                    blending: THREE.AdditiveBlending,
                    opacity: 0.6
                });
                const particles = new THREE.Points(nebulaGeo, nebulaMat);
                mesh.add(particles);
                m78Glow = particles;
            }

            const lineGeo = new THREE.BufferGeometry().setFromPoints([
                new THREE.Vector3(0, 0, 0),
                new THREE.Vector3(star.realX, star.realY, star.realZ)
            ]);
            const lineMat = new THREE.LineDashedMaterial({
                color: 0x444444,
                dashSize: 10,
                gapSize: 5,
                opacity: 0.3,
                transparent: true
            });
            const sightLine = new THREE.Line(lineGeo, lineMat);
            sightLine.computeLineDistances();
            scene.add(sightLine);

            const labelDiv = document.createElement('div');
            labelDiv.className = `star-label ${star.type === 'nebula' ? 'm78-highlight' : ''}`;
            labelDiv.innerHTML = `<div class="label-name">${star.name}</div><div class="label-dist">${star.z} å…‰å¹´</div>`;
            document.body.appendChild(labelDiv);
            labelElements.push({ div: labelDiv, mesh: mesh });
        });

        connections.forEach(pair => {
            const start = stars[pair[0]];
            const end = stars[pair[1]];
            const points = [
                new THREE.Vector3(start.realX, start.realY, start.realZ),
                new THREE.Vector3(end.realX, end.realY, end.realZ)
            ];
            const geometry = new THREE.BufferGeometry().setFromPoints(points);
            const material = new THREE.LineBasicMaterial({ color: 0x3b82f6, opacity: 0.6, transparent: true });
            const line = new THREE.Line(geometry, material);
            scene.add(line);
        });

        const earthGeo = new THREE.SphereGeometry(2, 16, 16);
        const earthMat = new THREE.MeshBasicMaterial({ color: 0x22c55e });
        const earthMesh = new THREE.Mesh(earthGeo, earthMat);
        scene.add(earthMesh);
        
        const earthLabel = document.createElement('div');
        earthLabel.className = 'star-label text-green-400 font-bold';
        earthLabel.textContent = "åœ°çƒ (åŸç‚¹)";
        document.body.appendChild(earthLabel);
        labelElements.push({ div: earthLabel, mesh: earthMesh });

        const axisGroup = new THREE.Group();
        const axisLength = 2200;
        const axisGeo = new THREE.BufferGeometry().setFromPoints([
            new THREE.Vector3(0, -100, 0),
            new THREE.Vector3(0, -100, axisLength)
        ]);
        const axisMat = new THREE.LineBasicMaterial({ color: 0x666666 });
        const axisLine = new THREE.Line(axisGeo, axisMat);
        axisGroup.add(axisLine);

        for(let z=0; z<=axisLength; z+=400) {
            const tickGeo = new THREE.BufferGeometry().setFromPoints([
                new THREE.Vector3(-10, -100, z),
                new THREE.Vector3(10, -100, z)
            ]);
            const tickLine = new THREE.Line(tickGeo, axisMat);
            axisGroup.add(tickLine);
        }
        scene.add(axisGroup);


        // --- 5. äº¤äº’é€»è¾‘ (æ‚¬æµ® + ç‚¹å‡» + é¢æ¿æŠ˜å ) ---
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        const tooltip = document.getElementById('tooltip');
        const modal = document.getElementById('detail-modal');
        const modalContent = document.getElementById('modal-content');
        const controlsPanel = document.getElementById('controls-panel');

        // é¢æ¿æŠ˜å åŠŸèƒ½
        window.togglePanel = function() {
            controlsPanel.classList.toggle('collapsed');
        };

        // ç§»åŠ¨ç«¯åˆå§‹åŒ–æ£€æµ‹
        if (window.innerWidth < 768) {
            controlsPanel.classList.add('collapsed');
        }

        // å…³é—­æ¨¡æ€æ¡†
        window.closeModal = function() {
            modal.classList.remove('active');
        };

        // é¼ æ ‡ç§»åŠ¨æ£€æµ‹
        function onMouseMove(event) {
            // åœ¨ç§»åŠ¨ç«¯ï¼Œå¦‚æœæ­£åœ¨è§¦æ‘¸æ“ä½œï¼Œé€šå¸¸ä¸æ˜¾ç¤º Tooltipï¼Œæˆ–è€…é€šè¿‡ click è§¦å‘
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(starMeshes);

            if (intersects.length > 0) {
                const data = intersects[0].object.userData;
                // æ˜¾ç¤ºç®€æ˜“æ‚¬æµ®æç¤º
                tooltip.style.display = 'block';
                tooltip.style.left = event.clientX + 15 + 'px';
                tooltip.style.top = event.clientY + 15 + 'px';
                tooltip.innerHTML = `<div>${data.name}</div><div style="color:#aaa">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</div>`;
                document.body.style.cursor = 'pointer';
            } else {
                tooltip.style.display = 'none';
                document.body.style.cursor = 'default';
            }
        }
        
        // é¼ æ ‡ç‚¹å‡»æ£€æµ‹ (æ–°å¢)
        function onClick(event) {
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(starMeshes);

            if (intersects.length > 0) {
                const data = intersects[0].object.userData;
                showDetails(data);
            }
        }

        function showDetails(data) {
            // è®¡ç®—ç¥èˆŸé£èˆ¹æ—¶é—´ (å•ä½ï¼šå¹´)
            const shenzhouYears = (data.z * YEARS_PER_LY_SHENZHOU).toLocaleString();

            modalContent.innerHTML = `
                <div class="modal-title">${data.name}</div>
                <div class="modal-subtitle">è·ç¦»åœ°çƒ: <span style="color:white">${data.z}</span> å…‰å¹´</div>
                <div class="modal-body">
                    ${data.desc}
                </div>
                
                <!-- ç¥èˆŸé£èˆ¹æ•°æ®å¡ç‰‡ -->
                <div class="mt-4 p-3 bg-blue-900/30 rounded-lg border border-blue-500/20">
                    <div class="flex items-center text-xs text-blue-300 font-bold mb-1">
                        <span class="mr-2 text-lg">ğŸš€</span> ç¥èˆŸé£èˆ¹é£è¿‡å»è¦å¤šä¹…ï¼Ÿ
                    </div>
                    <div class="text-sm text-white pl-7">
                        çº¦ <span class="font-mono text-yellow-400 text-lg font-bold">${shenzhouYears}</span> å¹´
                    </div>
                    <div class="text-[10px] text-gray-500 pl-7 mt-1">
                        (å‡è®¾ä»¥ç¬¬ä¸€å®‡å®™é€Ÿåº¦ 7.9km/s ä¸é—´æ–­é£è¡Œ)
                    </div>
                </div>
            `;
            modal.classList.add('active');
        }

        window.addEventListener('mousemove', onMouseMove, false);
        window.addEventListener('click', onClick, false);
        // æ·»åŠ è§¦æ‘¸æ”¯æŒï¼Œç¡®ä¿ç§»åŠ¨ç«¯ç‚¹å‡»ç”Ÿæ•ˆ
        window.addEventListener('touchstart', (e) => {
             // ç®€å•çš„è§¦æ‘¸ç‚¹å‡»å¤„ç†ï¼Œé˜²æ­¢ä¸ OrbitControls å†²çªè¿‡äºå¤æ‚
             // è¿™é‡Œä¸»è¦ä¾èµ– OrbitControls å¤„ç†æ—‹è½¬ï¼Œclick äº‹ä»¶é€šå¸¸ä¹Ÿä¼šåœ¨ touchEnd åè§¦å‘
        }, {passive: true});


        // --- 6. è§†è§’æ§åˆ¶ ---
        function updateLabels() {
            labelElements.forEach(item => {
                const vector = item.mesh.position.clone();
                vector.project(camera);

                if (vector.z > 1) { 
                    item.div.classList.remove('visible');
                    return;
                }
                const x = (vector.x * .5 + .5) * window.innerWidth;
                const y = (-(vector.y * .5) + .5) * window.innerHeight;

                if(x < 0 || x > window.innerWidth || y < 0 || y > window.innerHeight) {
                    item.div.classList.remove('visible');
                } else {
                    item.div.style.left = `${x}px`;
                    item.div.style.top = `${y}px`;
                    item.div.classList.add('visible');
                }
            });
        }

        camera.position.set(-200, 100, 1000); 
        controls.target.set(0, 0, 800);
        controls.update();

        function moveCamera(pos, target) {
            new TWEEN.Tween(camera.position)
                .to(pos, 2000)
                .easing(TWEEN.Easing.Cubic.InOut)
                .start();

            new TWEEN.Tween(controls.target)
                .to(target, 2000)
                .easing(TWEEN.Easing.Cubic.InOut)
                .onUpdate(() => controls.update())
                .start();
        }

        window.setEarthView = function() {
            moveCamera({ x: 0, y: 0, z: -300 }, { x: 0, y: 0, z: 800 });
            // ç§»åŠ¨ç«¯ç‚¹å‡»æŒ‰é’®åè‡ªåŠ¨æ”¶èµ·é¢æ¿ï¼Œæ–¹ä¾¿æŸ¥çœ‹æ•ˆæœ
            if (window.innerWidth < 768) {
                controlsPanel.classList.add('collapsed');
            }
        };

        window.setGodView = function() {
            moveCamera({ x: 2000, y: 500, z: 800 }, { x: 0, y: 0, z: 800 });
            if (window.innerWidth < 768) {
                controlsPanel.classList.add('collapsed');
            }
        };

        // --- 7. æ¸²æŸ“å¾ªç¯ ---
        const clock = new THREE.Clock();

        function animate() {
            requestAnimationFrame(animate);
            const time = clock.getElapsedTime();

            if (m78Glow) {
                const scale = 1 + Math.sin(time * 2) * 0.1;
                m78Glow.scale.set(scale, scale, scale);
                m78Mesh.rotation.z = time * 0.1; 
            }

            TWEEN.update();
            controls.update();
            updateLabels();
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        setTimeout(() => {
            document.getElementById('loading').style.opacity = 0;
            setTimeout(() => document.getElementById('loading').style.display = 'none', 1000);
            animate();
            setEarthView();
        }, 1000);

    </script>
</body>
</html>